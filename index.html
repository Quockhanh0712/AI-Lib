<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhận diện khuôn mặt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .error { color: red; }
        .success { color: green; }
        #webcam, #final-frame, #capture-webcam { width: 100%; max-width: 224px; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6">Nhận diện khuôn mặt</h1>

        <!-- Thêm người dùng -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Thêm người dùng</h2>
            <form id="add-user-form" class="space-y-2">
                <input type="text" id="member_code" name="member_code" required class="w-full p-2 border rounded" placeholder="Mã thành viên">
                <input type="text" id="full_name" name="full_name" required class="w-full p-2 border rounded" placeholder="Họ và tên">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Thêm</button>
            </form>
            <p id="add-user-message" class="mt-2"></p>
        </div>

        <!-- Thêm ảnh khuôn mặt -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Thêm ảnh khuôn mặt</h2>
            <form id="add-face-form" enctype="multipart/form-data" class="space-y-2">
                <input type="text" id="face_member_code" name="member_code" required class="w-full p-2 border rounded" placeholder="Mã thành viên">
                <div class="mb-2">
                    <video id="capture-webcam" autoplay playsinline class="mb-2 hidden"></video>
                    <button type="button" id="start-capture" class="bg-green-500 text-white px-4 py-2 rounded w-full mb-2">Chụp từ webcam</button>
                    <button type="button" id="take-snapshot" class="bg-blue-500 text-white px-4 py-2 rounded w-full mb-2 hidden">Chụp ảnh</button>
                    <button type="button" id="cancel-capture" class="bg-red-500 text-white px-4 py-2 rounded w-full mb-2 hidden">Hủy</button>
                </div>
                <input type="file" id="files" name="files" accept="image/*" multiple class="w-full p-2 border rounded" onchange="validateFiles(this)">
                <p class="text-sm text-gray-500">Tải lên tối đa 3 ảnh hoặc chụp từ webcam</p>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Tải lên</button>
            </form>
            <p id="add-face-message" class="mt-2"></p>
        </div>

        <!-- Nhận diện -->
        <div>
            <h2 class="text-xl font-semibold mb-2">Nhận diện khuôn mặt</h2>
            <video id="webcam" autoplay playsinline class="mb-2"></video>
            <button id="start-recognition" class="bg-green-500 text-white px-4 py-2 rounded w-full mb-2">Bắt đầu nhận diện</button>
            <button id="stop-recognition" class="bg-red-500 text-white px-4 py-2 rounded w-full mb-2 hidden">Dừng nhận diện</button>
            <img id="final-frame" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Frame cuối" class="mb-2 hidden">
            <p id="recognition-info" class="mt-2"></p>
            <form id="confirm-attendance-form" class="space-y-2 hidden">
                <input type="text" id="confirm_member_code" name="confirm_member_code" required class="w-full p-2 border rounded" placeholder="Nhập mã thành viên">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Xác nhận điểm danh</button>
            </form>
            <p id="message" class="mt-2"></p>
        </div>

        <!-- Cập nhật thời gian rời đi -->
        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">Cập nhật thời gian rời đi</h2>
            <form id="update-exit-time-form" class="space-y-2">
                <input type="text" id="exit_member_code" name="exit_member_code" required class="w-full p-2 border rounded" placeholder="Nhập mã thành viên">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Cập nhật rời đi</button>
            </form>
            <p id="exit-message" class="mt-2"></p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let stream = null, isRecognizing = false, captureStream = null;
        const webcam = document.getElementById('webcam');
        const captureWebcam = document.getElementById('capture-webcam');
        const startButton = document.getElementById('start-recognition');
        const stopButton = document.getElementById('stop-recognition');
        const startCaptureButton = document.getElementById('start-capture');
        const takeSnapshotButton = document.getElementById('take-snapshot');
        const cancelCaptureButton = document.getElementById('cancel-capture');
        const confirmForm = document.getElementById('confirm-attendance-form');
        const finalFrame = document.getElementById('final-frame');
        const messageEl = document.getElementById('message');
        const recognitionInfoEl = document.getElementById('recognition-info');
        const canvas = document.createElement('canvas');
        let webcamFrame = null;

        async function startWebcam(videoElement) {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 224, height: 224 } });
            videoElement.srcObject = stream;
            canvas.width = 224;
            canvas.height = 224;
            return stream;
        }

        function stopWebcam(stream, videoElement) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
        }

        async function processFrame() {
            if (!isRecognizing) return;
            canvas.getContext('2d').drawImage(webcam, 0, 0, 224, 224);
            const frameData = canvas.toDataURL('image/jpeg', 0.8);
            try {
                const response = await fetch(`${API_BASE_URL}/process-frame`, {
                    method: 'POST',
                    body: JSON.stringify({ frame: frameData }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.full_name && data.similarity) {
                    recognitionInfoEl.textContent = `Nhận diện: ${data.full_name} (Độ chính xác: ${(data.similarity * 100).toFixed(2)}%)`;
                    recognitionInfoEl.className = 'success';
                } else {
                    recognitionInfoEl.textContent = '';
                }
                messageEl.textContent = data.status;
                messageEl.className = data.status === 'Nhận diện thành công' ? 'success' : 'error';
                if (data.status === 'Nhận diện thành công') {
                    isRecognizing = false;
                    stopWebcam(stream, webcam);
                    stream = null;
                    startButton.classList.remove('hidden');
                    stopButton.classList.add('hidden');
                    confirmForm.classList.remove('hidden');
                    finalFrame.src = data.final_frame || '';
                    finalFrame.classList.remove('hidden');
                    document.getElementById('confirm_member_code').focus();
                } else {
                    setTimeout(processFrame, 250);
                }
            } catch (error) {
                messageEl.textContent = 'Lỗi mạng: ' + error.message;
                messageEl.className = 'error';
                isRecognizing = false;
                stopWebcam(stream, webcam);
                stream = null;
                startButton.classList.remove('hidden');
                stopButton.classList.add('hidden');
            }
        }

        startButton.addEventListener('click', async () => {
            if (!stream) stream = await startWebcam(webcam);
            isRecognizing = true;
            startButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            messageEl.textContent = 'Đang nhận diện...';
            messageEl.className = 'success';
            confirmForm.classList.add('hidden');
            finalFrame.classList.add('hidden');
            recognitionInfoEl.textContent = '';
            processFrame();
        });

        stopButton.addEventListener('click', () => {
            isRecognizing = false;
            stopWebcam(stream, webcam);
            stream = null;
            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
            messageEl.textContent = 'Đã dừng nhận diện';
            messageEl.className = 'success';
            recognitionInfoEl.textContent = '';
        });

        startCaptureButton.addEventListener('click', async () => {
            captureStream = await startWebcam(captureWebcam);
            captureWebcam.classList.remove('hidden');
            startCaptureButton.classList.add('hidden');
            takeSnapshotButton.classList.remove('hidden');
            cancelCaptureButton.classList.remove('hidden');
        });

        takeSnapshotButton.addEventListener('click', () => {
            canvas.getContext('2d').drawImage(captureWebcam, 0, 0, 224, 224);
            webcamFrame = canvas.toDataURL('image/jpeg', 0.8);
            stopWebcam(captureStream, captureWebcam);
            captureStream = null;
            captureWebcam.classList.add('hidden');
            startCaptureButton.classList.remove('hidden');
            takeSnapshotButton.classList.add('hidden');
            cancelCaptureButton.classList.add('hidden');
            messageEl.textContent = 'Đã chụp ảnh từ webcam';
            messageEl.className = 'success';
        });

        cancelCaptureButton.addEventListener('click', () => {
            stopWebcam(captureStream, captureWebcam);
            captureStream = null;
            webcamFrame = null;
            captureWebcam.classList.add('hidden');
            startCaptureButton.classList.remove('hidden');
            takeSnapshotButton.classList.add('hidden');
            cancelCaptureButton.classList.add('hidden');
            messageEl.textContent = 'Đã hủy chụp ảnh';
            messageEl.className = 'success';
        });

        function validateFiles(input) {
            if (input.files.length > 3) {
                alert('Chỉ được tải lên tối đa 3 ảnh!');
                input.value = '';
            }
        }

        document.getElementById('add-face-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('member_code', document.getElementById('face_member_code').value);
            if (webcamFrame) {
                formData.append('webcam_frame', webcamFrame);
            }
            const fileInput = document.getElementById('files');
            for (const file of fileInput.files) {
                formData.append('files', file);
            }
            const messageEl = document.getElementById('add-face-message');
            try {
                const response = await fetch(`${API_BASE_URL}/add-face`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                messageEl.textContent = response.ok ? data.status : data.detail;
                messageEl.className = response.ok ? 'success' : 'error';
                if (response.ok) {
                    e.target.reset();
                    webcamFrame = null;
                    fileInput.value = '';
                }
            } catch (error) {
                messageEl.textContent = 'Lỗi mạng: ' + error.message;
                messageEl.className = 'error';
            }
        });

        document.getElementById('confirm-attendance-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberCode = document.getElementById('confirm_member_code').value;
            try {
                const response = await fetch(`${API_BASE_URL}/confirm-attendance`, {
                    method: 'POST',
                    body: JSON.stringify({ member_code: memberCode }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (response.ok) {
                    messageEl.textContent = `Đã điểm danh: ${data.full_name} (Ca: ${data.shift})`;
                    messageEl.className = 'success';
                    confirmForm.classList.add('hidden');
                    startButton.classList.remove('hidden');
                    finalFrame.classList.add('hidden');
                    recognitionInfoEl.textContent = '';
                } else {
                    messageEl.textContent = data.detail;
                    messageEl.className = 'error';
                }
            } catch (error) {
                messageEl.textContent = 'Lỗi mạng: ' + error.message;
                messageEl.className = 'error';
            }
        });

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const messageEl = document.getElementById('add-user-message');
            try {
                const response = await fetch(`${API_BASE_URL}/add-user`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                messageEl.textContent = response.ok ? `Đã thêm: ID ${data.id}` : data.detail;
                messageEl.className = response.ok ? 'success' : 'error';
                if (response.ok) e.target.reset();
            } catch (error) {
                messageEl.textContent = 'Lỗi mạng: ' + error.message;
                messageEl.className = 'error';
            }
        });

        document.getElementById('update-exit-time-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberCode = document.getElementById('exit_member_code').value;
            const messageEl = document.getElementById('exit-message');
            try {
                const response = await fetch(`${API_BASE_URL}/update-exit-time`, {
                    method: 'POST',
                    body: JSON.stringify({ member_code: memberCode }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                messageEl.textContent = response.ok ? `Đã cập nhật: ${data.full_name} (Thời gian: ${data.duration_minutes} phút)` : data.detail;
                messageEl.className = response.ok ? 'success' : 'error';
                if (response.ok) e.target.reset();
            } catch (error) {
                messageEl.textContent = 'Lỗi mạng: ' + error.message;
                messageEl.className = 'error';
            }
        });

        window.addEventListener('unload', () => {
            stopWebcam(stream, webcam);
            stopWebcam(captureStream, captureWebcam);
        });
    </script>
</body>
</html>