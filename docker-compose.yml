# docker-compose.yml
# Đặt file này ở thư mục gốc của dự án (AI-Lib/)

version: '3.8' # Phiên bản Docker Compose

services:
  # Dịch vụ Database (MySQL)
  db:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: lib_ai
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: root_password_for_dev
      TZ: UTC # <<< THÊM DÒNG NÀY ĐỂ ĐẶT MÚI GIỜ CONTAINER LÀ UTC
    volumes:
      - db_data:/var/lib/mysql
      - ./db:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Dịch vụ Backend
  backend:
    build: ./backend # Đường dẫn đến thư mục chứa Dockerfile của backend
    ports:
      - "8000:8000" # Ánh xạ cổng API backend
    environment:
      # ĐÃ SỬA: Thêm ?charset=utf8mb4 vào cuối chuỗi kết nối để đảm bảo encoding đúng
      environment:
      DATABASE_URL: mysql+pymysql://user:password@db:3306/lib_ai?charset=utf8mb4
      # Các biến MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE không cần thiết ở đây nữa
      # vì DATABASE_URL đã được định nghĩa đầy đủ.
      # AI_MODEL_PATH: /app/models/face_recognition_model.pth
    volumes:
      # Ánh xạ volume cho dữ liệu backend (nếu backend lưu file ảnh, model, v.v.)
      - backend_data:/usr/src/app/data
      # Nếu bạn muốn live-reload code backend khi phát triển, có thể ánh xạ thư mục code:
      # - ./backend:/usr/src/app
    depends_on:
      db: # Backend phụ thuộc vào database
        condition: service_healthy # Chỉ khởi động backend khi database sẵn sàng


  # Dịch vụ Frontend Người dùng (Cổng máy) - PHIÊN BẢN REACT
  frontend-user:
    build:
      context: ./frontend-user-react # Đường dẫn đến thư mục React mới
      args: # <<< ĐÃ SỬA LỖI THỤT LỀ Ở ĐÂY
        VITE_BACKEND_API_URL: http://localhost:8000/machine # ĐÃ SỬA: Sử dụng localhost
    ports:
      - "8082:80" # Ánh xạ cổng cho frontend user
    depends_on:
      - backend # Frontend user phụ thuộc vào backend để gọi API

  # Dịch vụ Frontend Admin
  frontend-admin:
    build:
      context: ./frontend-admin
      args: # <<< ĐÃ SỬA LỖI THỤT LỀ Ở ĐÂY
        VITE_BACKEND_API_URL: http://localhost:8000/machine # ĐÃ SỬA: Sử dụng localhost
    ports:
      - "8083:80"
    depends_on:
      - backend

# Định nghĩa các Volumes để lưu trữ dữ liệu bền vững
volumes:
  db_data: # Volume cho dữ liệu database MySQL
  backend_data: # Volume cho dữ liệu backend (nếu có)
  # frontend_user_data: # Volume cho frontend user (nếu cần)
  # frontend_admin_data: # Volume cho frontend admin (nếu cần)
